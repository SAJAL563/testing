<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            background: linear-gradient(135deg, #1a0033, #330066);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video {
            width: 90%;
            height: auto;
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <video id="videoPlayer" controls></video>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const proxyUrl = "https://cors-proxy-fawn.vercel.app/proxy?url=";
        const originalM3U8Url = "https://cors-proxy-fawn.vercel.app/proxy?url=https://d27h84tpitp9e0.cloudfront.net/ivs/v1/916749774596/cv7OeduHYcU8/2025/1/15/7/11/sRjo9dMRool0/media/hls/1080p60/playlist_vod.m3u8";

        const video = document.getElementById('videoPlayer');
        let hls = null; // Store HLS instance globally

        // Global variable to store the modified playlist
        let modifiedPlaylist = "";

        // Function to fetch, modify, and store the M3U8 playlist and its TS segments locally
        async function fetchAndStoreM3U8(url) {
            try {
                // Fetch the M3U8 playlist
                const response = await fetch(url);
                const playlist = await response.text();

                // Base URL for resolving relative TS URLs
                const baseUrl = url.match(/.+\//)[0];

                // Extract and modify TS segment URLs
                let newModifiedPlaylist = playlist.replace(/([^\n]+\.ts)/g, (match) => {
                    const fullTsUrl = `${baseUrl}${match}`;
                    return `${proxyUrl}${fullTsUrl}`;
                });

                // Update the global modifiedPlaylist by appending only new segments
                if (modifiedPlaylist) {
                    const newSegments = newModifiedPlaylist.split('\n').filter(line => line.includes('.ts'));
                    newSegments.forEach(segment => {
                        if (!modifiedPlaylist.includes(segment)) {
                            modifiedPlaylist += "\n" + segment;
                        }
                    });
                } else {
                    modifiedPlaylist = newModifiedPlaylist;
                }

                // Create a Blob for the modified M3U8 playlist
                const m3u8Blob = new Blob([modifiedPlaylist], { type: 'application/x-mpegURL' });
                const localM3U8Url = URL.createObjectURL(m3u8Blob);

                return localM3U8Url;
            } catch (error) {
                console.error("Error fetching or modifying the M3U8 playlist:", error);
            }
        }

        // Function to keep the player running and updating the playlist
        function startPeriodicFetch() {
            let isFetching = false;

            setInterval(async () => {
                if (isFetching) return;

                isFetching = true;

                const localM3U8Url = await fetchAndStoreM3U8(originalM3U8Url);
                if (localM3U8Url && hls) {
                    const currentTime = video.currentTime;
                    const wasPlaying = !video.paused;
                    
                    // Update the source without creating a new HLS instance
                    hls.loadSource(localM3U8Url);
                    
                    // Restore playback state
                    video.currentTime = currentTime;
                    if (wasPlaying) {
                        video.play();
                    }
                    
                    console.log("Updated playlist loaded with new segments.");
                } else {
                    console.error("Failed to update the modified M3U8 playlist.");
                }

                isFetching = false;
            }, 10000);
        }

        // Initialize HLS.js player
        if (Hls.isSupported()) {
            hls = new Hls({
                maxBufferLength: 30,
                maxMaxBufferLength: 600,
                maxBufferSize: 60 * 1000 * 1000,
                maxBufferHole: 0.5,
                lowLatencyMode: true
            });

            // Fetch and store the initial M3U8 playlist
            fetchAndStoreM3U8(originalM3U8Url).then((localM3U8Url) => {
                if (localM3U8Url) {
                    hls.loadSource(localM3U8Url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, function () {
                        console.log("Manifest loaded, video ready to play!");
                        video.play().catch(e => console.log("Playback failed:", e));
                    });

                    // Start periodic fetch to update playlist every 10 seconds
                    startPeriodicFetch();
                } else {
                    console.error("Failed to load the modified M3U8 playlist.");
                }
            });
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            fetchAndStoreM3U8(originalM3U8Url).then((localM3U8Url) => {
                if (localM3U8Url) {
                    video.src = localM3U8Url;
                    startPeriodicFetch();
                } else {
                    console.error("Failed to load the modified M3U8 playlist.");
                }
            });
        } else {
            alert("Your browser does not support HLS streaming.");
        }
    </script>
</body>
</html>
