<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            background: linear-gradient(135deg, #1a0033, #330066);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container {
            width: 90%;
            max-width: 1280px;
            position: relative;
        }

        video {
            width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="video" controls autoplay></video>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.3/shaka-player.compiled.js"></script>
    <script>
        const proxyUrl = "https://cors-proxy-fawn.vercel.app/proxy?url=";
        const originalM3U8Url = "https://cors-proxy-fawn.vercel.app/proxy?url=https://d27h84tpitp9e0.cloudfront.net/ivs/v1/916749774596/cv7OeduHYcU8/2025/1/15/7/11/sRjo9dMRool0/media/hls/1080p60/playlist_vod.m3u8";

        async function initPlayer() {
            // Install built-in polyfills to patch browser incompatibilities
            shaka.polyfill.installAll();

            // Check if the browser supports the player
            if (!shaka.Player.isBrowserSupported()) {
                console.error('Browser not supported!');
                return;
            }

            try {
                // Create a Player instance
                const video = document.getElementById('video');
                const player = new shaka.Player(video);

                // Configure player: force HTTP even if HTTPS is available
                player.configure({
                    streaming: {
                        retryParameters: {
                            maxAttempts: 5,
                            baseDelay: 1000,
                            backoffFactor: 2,
                            fuzzFactor: 0.5
                        },
                        bufferingGoal: 60,
                        rebufferingGoal: 2,
                        bufferBehind: 30
                    },
                    manifest: {
                        retryParameters: {
                            maxAttempts: 5,
                            baseDelay: 1000,
                            backoffFactor: 2,
                            fuzzFactor: 0.5
                        }
                    }
                });

                // Listen for errors
                player.addEventListener('error', onError);

                // Create custom network filter to handle proxy URLs
                player.getNetworkingEngine().registerRequestFilter((type, request) => {
                    // Only modify segment requests
                    if (type == shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                        request.uris = request.uris.map(uri => {
                            if (!uri.startsWith(proxyUrl)) {
                                return `${proxyUrl}${encodeURIComponent(uri)}`;
                            }
                            return uri;
                        });
                    }
                });

                // Load the manifest
                await player.load(originalM3U8Url);

                // Update manifest periodically
                setInterval(async () => {
                    try {
                        const currentTime = video.currentTime;
                        await player.load(originalM3U8Url);
                        video.currentTime = currentTime;
                    } catch (error) {
                        console.error('Error updating manifest:', error);
                    }
                }, 10000);

                console.log('The video has now been loaded!');
            } catch (error) {
                onError(error);
            }
        }

        function onError(error) {
            console.error('Error code', error.code, 'object', error);
        }

        // Listen to the load event to initialize the player
        document.addEventListener('DOMContentLoaded', initPlayer);
    </script>
</body>
</html>
