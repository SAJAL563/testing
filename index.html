<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Player</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            background: linear-gradient(135deg, #1a0033, #330066);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container {
            width: 90%;
            max-width: 1280px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        .plyr {
            width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="videoPlayer"></video>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/plyr/3.7.8/plyr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const proxyUrl = "https://cors-proxy-fawn.vercel.app/proxy?url=";
        const originalM3U8Url = "https://cors-proxy-fawn.vercel.app/proxy?url=https://d27h84tpitp9e0.cloudfront.net/ivs/v1/916749774596/cv7OeduHYcU8/2025/1/15/7/11/sRjo9dMRool0/media/hls/1080p60/playlist_vod.m3u8";

        let modifiedPlaylist = "";
        let hls = null;
        let currentSegments = new Set();

        // Initialize Plyr
        const player = new Plyr('#videoPlayer', {
            controls: [
                'play-large',
                'play',
                'progress',
                'current-time',
                'duration',
                'mute',
                'volume',
                'settings',
                'fullscreen'
            ],
            settings: ['quality', 'speed'],
            quality: {
                default: 1080,
                options: [1080]
            }
        });

        async function fetchAndStoreM3U8(url) {
            try {
                const response = await fetch(url);
                const playlist = await response.text();
                const baseUrl = url.match(/.+\//)[0];

                // Parse segments from the new playlist
                const newSegments = playlist.match(/[^\n]+\.ts/g) || [];
                const newSegmentsSet = new Set(newSegments);

                // Only modify playlist to include new segments
                newSegments.forEach(segment => {
                    if (!currentSegments.has(segment)) {
                        currentSegments.add(segment);
                        const fullTsUrl = `${baseUrl}${segment}`;
                        const proxiedUrl = `${proxyUrl}${encodeURIComponent(fullTsUrl)}`;
                        
                        if (!modifiedPlaylist.includes(proxiedUrl)) {
                            modifiedPlaylist += `\n${proxiedUrl}`;
                        }
                    }
                });

                // Combine headers and segments
                const headers = playlist.match(/^#.*$/gm).join('\n');
                const finalPlaylist = `${headers}${modifiedPlaylist}`;

                const blob = new Blob([finalPlaylist], { type: 'application/x-mpegURL' });
                return URL.createObjectURL(blob);

            } catch (error) {
                console.error("Error fetching or modifying the M3U8 playlist:", error);
                return null;
            }
        }

        function initializePlayer(url) {
            if (Hls.isSupported()) {
                hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90,
                    maxBufferSize: 0,
                    maxBufferLength: 30,
                    maxMaxBufferLength: 600,
                });

                hls.attachMedia(player.media);

                hls.on(Hls.Events.MEDIA_ATTACHED, () => {
                    console.log('HLS media attached');
                    hls.loadSource(url);
                });

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    console.log('HLS manifest parsed');
                    player.play().catch(() => {
                        console.log("Playback failed, likely due to autoplay policy");
                    });
                });

                hls.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        switch (data.type) {
                            case Hls.ErrorTypes.NETWORK_ERROR:
                                console.log('Fatal network error, trying to recover');
                                hls.startLoad();
                                break;
                            case Hls.ErrorTypes.MEDIA_ERROR:
                                console.log('Fatal media error, trying to recover');
                                hls.recoverMediaError();
                                break;
                            default:
                                console.log('Fatal error, cannot recover');
                                hls.destroy();
                                break;
                        }
                    }
                });

            } else if (player.media.canPlayType('application/vnd.apple.mpegurl')) {
                player.media.src = url;
            }
        }

        // Start the player
        fetchAndStoreM3U8(originalM3U8Url).then(localUrl => {
            if (localUrl) {
                initializePlayer(localUrl);
                
                // Update playlist periodically
                setInterval(async () => {
                    const newUrl = await fetchAndStoreM3U8(originalM3U8Url);
                    if (newUrl && hls) {
                        const currentTime = player.media.currentTime;
                        const wasPlaying = !player.media.paused;
                        
                        hls.loadSource(newUrl);
                        
                        player.media.currentTime = currentTime;
                        if (wasPlaying) {
                            player.play();
                        }
                    }
                }, 10000);
            }
        });

        // Handle player destruction on page unload
        window.addEventListener('beforeunload', () => {
            if (hls) {
                hls.destroy();
            }
            player.destroy();
        });
    </script>
</body>
</html>
